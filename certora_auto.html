<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certora Auto Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .url-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            transition: border-color 0.3s;
            margin-bottom: 20px;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-info {
            background: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .status-success {
            background: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        .status-error {
            background: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }

        .result-section {
            display: none;
        }

        .result-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 24px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 10px;
        }

        .rule-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .rule-card:hover {
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .rule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .rule-name {
            font-weight: 600;
            color: #212529;
            font-size: 16px;
        }

        .rule-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-violated {
            background: #dc3545;
            color: white;
        }

        .status-timeout {
            background: #ffc107;
            color: #212529;
        }

        .json-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .json-preview pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .markdown-output {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .markdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .markdown-title {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
        }

        .markdown-content {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .markdown-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .copy-btn {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .rule-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .rule-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rule-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .action-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Certora Auto Analyzer</h1>
            <p>Ëá™Âä®ÂàÜÊûêÂπ∂Ëé∑ÂèñÊâÄÊúâÈùûverifiedËßÑÂàôÁöÑJSONÂÜÖÂÆπ</p>
        </div>

        <div class="content">
            <div class="input-section">
                <h3 style="margin-bottom: 20px; color: #212529;">ËæìÂÖ• Certora URL</h3>
                <input type="text" 
                       class="url-input" 
                       id="certora-url" 
                       placeholder="https://prover.certora.com/output/..."
                       value="">
                
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeUrl()">
                    üîç ÂàÜÊûêÂπ∂Ëé∑ÂèñÊâÄÊúâJSON
                </button>

                <div id="status-message"></div>
            </div>

            <div id="result-section" class="result-section"></div>
        </div>
    </div>

    <script>
        let allRulesData = null;
        let jsonContents = {};

        async function analyzeUrl() {
            const url = document.getElementById('certora-url').value.trim();
            if (!url) {
                showStatus('ËØ∑ËæìÂÖ•URL', 'error');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ ÂàÜÊûê‰∏≠...';
            
            showStatus('Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...', 'info');

            try {
                // Ë∞ÉÁî®Êú¨Âú∞ÊúçÂä°
                const response = await fetch('http://localhost:3002/analyze-and-fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `ÊúçÂä°Âô®ÈîôËØØ: ${response.status}`);
                }

                const data = await response.json();
                allRulesData = data;
                
                // ‰øùÂ≠òÊâÄÊúâJSONÂÜÖÂÆπ
                data.rules.forEach(rule => {
                    if (rule.content) {
                        jsonContents[rule.outputFile] = rule.content;
                    }
                });

                displayResults(data);
                showStatus(`‚úÖ ÊàêÂäüËé∑Âèñ ${data.rules.length} ‰∏™ËßÑÂàôÁöÑÊï∞ÊçÆ`, 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus(`ÈîôËØØ: ${error.message}„ÄÇËØ∑Á°Æ‰øùËøêË°å‰∫Ü: node scripts/certora_auto_server.mjs`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç ÂàÜÊûêÂπ∂Ëé∑ÂèñÊâÄÊúâJSON';
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        function displayResults(data) {
            const resultSection = document.getElementById('result-section');
            
            let html = `
                <div class="result-header">
                    <div class="result-title">ÂàÜÊûêÁªìÊûú</div>
                    <div style="color: #6c757d; font-size: 14px;">
                        ÊâæÂà∞ ${data.rules.length} ‰∏™ÈùûverifiedËßÑÂàô<br>
                        ÊàêÂäüËé∑Âèñ ${data.rules.filter(r => r.content).length} ‰∏™JSONÊñá‰ª∂ÂÜÖÂÆπ
                    </div>
                </div>
                
                <div class="action-bar">
                    <!-- ÁßªÈô§‰∫ÜÁîüÊàêÊâÄÊúâMarkdownÊñáÊ°£„ÄÅ‰∏ãËΩΩÊâÄÊúâJSONÊñá‰ª∂„ÄÅÂØºÂá∫Ê±áÊÄªÊä•ÂëäÂäüËÉΩ -->
                </div>
            `;

            data.rules.forEach((rule, index) => {
                const statusClass = rule.status === 'TIMEOUT' ? 'status-timeout' : 'status-violated';
                const hasContent = rule.content !== null;
                
                html += `
                    <div class="rule-card">
                        <div class="rule-header">
                            <div class="rule-name">${formatRuleName(rule.ruleName)}</div>
                            <span class="rule-status ${statusClass}">${rule.status}</span>
                        </div>
                        
                        ${hasContent ? `
                            <div class="markdown-content" id="rule-content-${index}" style="display: none;">
                                <pre>ÁîüÊàê‰∏≠...</pre>
                            </div>
                        ` : `
                            <div style="color: #dc3545; padding: 10px; background: #f8d7da; border-radius: 6px;">
                                Ëé∑ÂèñÂ§±Ë¥•: ${rule.error || 'Êú™Áü•ÈîôËØØ'}
                            </div>
                        `}
                        
                        <div class="rule-actions">
                            ${hasContent ? `
                                <button class="rule-btn" onclick="toggleMarkdown(${index})">
                                    üìù ÊòæÁ§∫/ÈöêËóè MD
                                </button>
                                <button class="rule-btn" onclick="copyRuleMarkdown(${index})">
                                    üìã Â§çÂà∂ MD
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            resultSection.innerHTML = html;
            resultSection.style.display = 'block';
        }

        function generateMarkdown(index) {
            const rule = allRulesData.rules[index];
            if (!rule.content) return;

            const md = convertToMarkdown(rule);
            displayMarkdown(md, rule.ruleName); // ‰ΩøÁî®ËßÑÂàôÂêç‰Ωú‰∏∫Êñá‰ª∂Âêç
        }

        function generateAllMarkdown() {
            if (!allRulesData) return;

            // Ê∏ÖÁ©∫‰πãÂâçÁöÑËæìÂá∫
            const existingOutputs = document.querySelectorAll('.markdown-output');
            existingOutputs.forEach(el => el.remove());

            allRulesData.rules.forEach((rule, index) => {
                if (rule.content) {
                    const md = convertToMarkdown(rule);
                    displayMarkdown(md, rule.ruleName);
                }
            });
            
            showStatus(`‚úÖ Â∑≤ÁîüÊàê ${allRulesData.rules.filter(r => r.content).length} ‰∏™MarkdownÊñáÊ°£`, 'success');
            
            // ÊªöÂä®Âà∞Á¨¨‰∏Ä‰∏™ÁîüÊàêÁöÑÊñáÊ°£
            setTimeout(() => {
                const firstOutput = document.querySelector('.markdown-output');
                if (firstOutput) {
                    firstOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // ‰ΩøÁî®certora_har_to_markdown.htmlÁöÑÂÆåÊï¥Ëß£ÊûêÈÄªËæë
        function convertToMarkdown(rule) {
            const traceData = rule.content;
            // ÁÆÄÂåñËßÑÂàôÂêçÁß∞ÔºåÂè™‰øùÁïôËøùÂèçÁöÑÈÇ£‰∏™ruleÔºåÂéªÊéâ‚Ü≥ÂèäÂêéÈù¢ÁöÑÂÜÖÂÆπ
            const simplifiedRuleName = rule.ruleName.split('‚Ü≥')[0].trim();
            let md = `# Certora Call Trace\n\n`;
            md += `**Rule:** ${simplifiedRuleName}\n`;
            md += `**Status:** ${rule.status}\n\n`;

            // 1. Call Trace (first position)
            if (traceData.callTrace) {
                md += `## üå≥ Call Trace\n\n`;
                let globalStateCounter = 1;
                md += convertTraceToMarkdown(traceData.callTrace, 0, { counter: globalStateCounter });
            }

            // 2. Variables (second position) - Áõ¥Êé•‰ªévariablesÊï∞ÁªÑ‰∏≠ÊèêÂèñ
            md += `\n## üìä Variables\n\n`;
            if (traceData.variables && Array.isArray(traceData.variables) && traceData.variables.length > 0) {
                md += renderVariablesFromArray(traceData.variables);
            } else {
                md += `ÊöÇÊó†ÂèòÈáèÊï∞ÊçÆ\n\n`;
            }

            // 3. Global State Diff (third position) - ‰ªéCall Trace‰∏≠ÁöÑGlobal StateËäÇÁÇπËÆ°ÁÆóÂèòÂåñ
            const globalStateDiff = calculateGlobalStateDiff(traceData.callTrace);
            if (Object.keys(globalStateDiff).length > 0) {
                md += `## üîÑ Global State Diff\n\n`;
                md += renderGlobalStateDiff(globalStateDiff);
            }

            // 4. Call Resolution Warnings (last position)
            if (traceData.callResolutionWarnings && traceData.callResolutionWarnings.length > 0) {
                md += `## üö® Call Resolution Warnings\n\n`;
                traceData.callResolutionWarnings.forEach((warning, index) => {
                    md += `### Warning #${index + 1}\n\n`;
                    if (warning.caller) {
                        md += `**Caller**: ${warning.caller.name || 'Unknown'}\n`;
                    }
                    if (warning.callee) {
                        md += `**Callee**: ${warning.callee.name || 'Unknown'}\n`;
                    }
                    if (warning.summary) {
                        md += `**Summary**: ${warning.summary}\n`;
                    }
                    if (warning.callSite) {
                        md += `**Call Site**: ${warning.callSite.snippet || 'Unknown'}\n`;
                        if (warning.callSite.jumpToDefinition) {
                            md += `**Location**: ${warning.callSite.jumpToDefinition.file}:${warning.callSite.jumpToDefinition.start.line}\n`;
                        }
                    }
                    if (warning.comments && warning.comments.length > 0) {
                        md += `**Comments**:\n`;
                        warning.comments.forEach(comment => {
                            if (typeof comment === 'object') {
                                const key = Object.keys(comment)[0];
                                md += `- **${key}**: ${comment[key]}\n`;
                            } else {
                                md += `- ${comment}\n`;
                            }
                        });
                    }
                    md += `\n`;
                });
            }

            return md;
        }

        // ‰ªécertora_har_to_markdown.htmlÂ§çÂà∂ÁöÑËæÖÂä©ÂáΩÊï∞
        function convertTraceToMarkdown(node, level, context = { counter: 1 }) {
            const indent = '  '.repeat(level);
            let md = '';

            let messageText = node.message?.text || '';
            if (node.message?.arguments) {
                node.message.arguments.forEach((arg, index) => {
                    const value = arg.value || (arg.values && arg.values[0]) || '?';
                    messageText = messageText.replace(`{${index}}`, value);
                });
            }

            // ‰∏∫ Global State Ê∑ªÂä†ÁºñÂè∑
            if (messageText === 'Global State') {
                messageText = `Global State #${context.counter}`;
                context.counter++;
            }

            const statusBadge = node.status && node.status.trim() ? ` **[${node.status}]**` : '';
            md += `${indent}- ${messageText}${statusBadge}\n`;

            if (node.childrenList && node.childrenList.length > 0) {
                node.childrenList.forEach(child => {
                    md += convertTraceToMarkdown(child, level + 1, context);
                });
            }

            return md;
        }

        // ‰ªévariablesÊï∞ÁªÑ‰∏≠Ê∏≤ÊüìÂ±ÇÊ¨°ÁªìÊûÑ
        function renderVariablesFromArray(variables) {
            let md = '';
            
            variables.forEach((variable, index) => {
                // Âè™Â§ÑÁêÜÊúâvariableNameÂ≠óÊÆµÁöÑÂØπË±°
                if (variable && typeof variable === 'object' && variable.hasOwnProperty('variableName')) {
                    // Â§ÑÁêÜÊúâchildrenListÁöÑÂèòÈáèÔºàÂ¶Ç eÔºâ
                    if (variable.hasOwnProperty('childrenList') && Array.isArray(variable.childrenList) && variable.childrenList.length > 0) {
                        md += renderNestedVariable(variable);
                    } else {
                        // ÁÆÄÂçïÂèòÈáèÔºåÁõ¥Êé•ËæìÂá∫ÂèòÈáèÂêçÂíåÂÄº
                        const name = variable.variableName;
                        const value = variable.hasOwnProperty('value') ? variable.value : 'undefined';
                        md += `${name}: \`${value}\`\n\n`;
                    }
                }
            });
            
            return md;
        }

        // Â§ÑÁêÜÂµåÂ•óÂèòÈáèÔºàÂ¶Ç e ÂèòÈáèÁöÑÂ≠êÂèòÈáèÔºâ
        function renderNestedVariable(variable, parentPath = []) {
            let md = '';
            const currentPath = parentPath.length > 0 ? [...parentPath, variable.variableName] : [variable.variableName];
            
            // Â¶ÇÊûúÊúâÂ≠êÂèòÈáèÔºåÈÄíÂΩíÂ§ÑÁêÜ
            if (variable.hasOwnProperty('childrenList') && Array.isArray(variable.childrenList) && variable.childrenList.length > 0) {
                variable.childrenList.forEach(child => {
                    // Á°Æ‰øùchildÊòØÊúâÊïàÁöÑÂØπË±°‰∏îÊúâvariableName
                    if (child && typeof child === 'object' && child.hasOwnProperty('variableName')) {
                        md += renderNestedVariable(child, currentPath);
                    }
                });
            } else {
                // Âè∂ËäÇÁÇπÔºåËæìÂá∫ÂÆåÊï¥Ë∑ØÂæÑÂíåÂÄº
                const fullPath = currentPath.join('.');
                const value = variable.hasOwnProperty('value') ? variable.value : 'undefined';
                md += `${fullPath}: \`${value}\`\n\n`;
            }
            
            return md;
        }

        // ËÆ°ÁÆóGlobal StateÂ∑ÆÂºÇ
        function calculateGlobalStateDiff(callTrace) {
            if (!callTrace) return {};
            
            const globalStateNodes = [];
            
            // Êî∂ÈõÜÊâÄÊúâGlobal StateËäÇÁÇπ
            collectGlobalStateNodes(callTrace, globalStateNodes);
            
            if (globalStateNodes.length === 0) {
                return {};
            }
            
            // ÊèêÂèñÁ¨¨‰∏Ä‰∏™ÂíåÊúÄÂêé‰∏Ä‰∏™Global StateÁöÑÁä∂ÊÄÅ
            const firstState = extractStateFromGlobalNode(globalStateNodes[0]);
            const lastState = extractStateFromGlobalNode(globalStateNodes[globalStateNodes.length - 1]);
            
            // ËÆ°ÁÆóÂ∑ÆÂºÇ
            const diff = {};
            
            // Êî∂ÈõÜÊâÄÊúâÁä∂ÊÄÅÈîÆ
            const allKeys = new Set([...Object.keys(firstState), ...Object.keys(lastState)]);
            
            allKeys.forEach(key => {
                const firstValue = firstState[key];
                const lastValue = lastState[key];
                
                // Âè™ÊúâÂΩìÂÄºÁ°ÆÂÆûÂèëÁîüÂèòÂåñÊó∂ÊâçËÆ∞ÂΩï
                if (firstValue !== lastValue) {
                    diff[key] = {
                        from: firstValue || 'undefined',
                        to: lastValue || 'undefined',
                        changed: true
                    };
                } else if (firstValue && lastValue) {
                    // ÂÄºÊ≤°ÊúâÂèòÂåñÔºå‰ΩÜÂ≠òÂú®‰∫é‰∏§‰∏™Áä∂ÊÄÅ‰∏≠
                    diff[key] = {
                        from: firstValue,
                        to: lastValue,
                        changed: false
                    };
                }
            });
            
            return diff;
        }

        // ÈÄíÂΩíÊî∂ÈõÜÊâÄÊúâGlobal StateËäÇÁÇπ
        function collectGlobalStateNodes(node, globalStateNodes) {
            if (node.message && node.message.text === "Global State") {
                globalStateNodes.push(node);
            }
            
            if (node.childrenList) {
                node.childrenList.forEach(child => {
                    collectGlobalStateNodes(child, globalStateNodes);
                });
            }
        }

        // ‰ªéGlobal StateËäÇÁÇπ‰∏≠ÊèêÂèñÁä∂ÊÄÅ‰ø°ÊÅØ
        function extractStateFromGlobalNode(globalStateNode) {
            const state = {};
            
            if (globalStateNode.childrenList) {
                globalStateNode.childrenList.forEach(child => {
                    extractStateRecursively(child, state);
                });
            }
            
            return state;
        }

        // ÈÄíÂΩíÊèêÂèñÁä∂ÊÄÅ‰ø°ÊÅØ
        function extractStateRecursively(node, state) {
            // Â¶ÇÊûúËäÇÁÇπÊúâargumentsÔºåËØ¥ÊòéËøôÊòØ‰∏Ä‰∏™Áä∂ÊÄÅËÆ∞ÂΩï
            if (node.message && node.message.arguments && node.message.arguments.length > 0) {
                // ÊõøÊç¢Âç†‰ΩçÁ¨¶ÂæóÂà∞ÂÆåÊï¥ÁöÑÁä∂ÊÄÅË∑ØÂæÑ
                let fullPath = node.message.text;
                let stateValue = null;
                
                node.message.arguments.forEach((arg, index) => {
                    const placeholder = `{${index}}`;
                    if (fullPath.includes(placeholder)) {
                        if (arg.value && arg.value !== '*') {
                            // ‰ΩøÁî®ÊúÄÊòìËØªÁöÑÂÄºË°®Á§∫
                            let displayValue = arg.value;
                            if (arg.values && arg.values.length > 1) {
                                // Â¶ÇÊûúÊúâÂçÅËøõÂà∂Ë°®Á§∫Ôºå‰ºòÂÖà‰ΩøÁî®
                                const decValue = arg.values.find(v => !v.startsWith('0x') && v !== arg.value && !isNaN(v));
                                if (decValue && parseInt(decValue) < 1000000) {
                                    displayValue = `${arg.value} (${decValue})`;
                                }
                            }
                            fullPath = fullPath.replace(placeholder, displayValue);
                            
                            // ÊúÄÂêé‰∏Ä‰∏™ÂèÇÊï∞ÈÄöÂ∏∏ÊòØÂÄº
                            if (index === node.message.arguments.length - 1) {
                                stateValue = displayValue;
                            }
                        } else {
                            fullPath = fullPath.replace(placeholder, arg.value || 'undefined');
                        }
                    }
                });
                
                // Ëß£ÊûêË∑ØÂæÑÂíåÂÄº
                const parsed = parseStatePath(fullPath, stateValue);
                if (parsed.path && parsed.value !== null) {
                    state[parsed.path] = parsed.value;
                }
            }
            
            // ÈÄíÂΩíÂ§ÑÁêÜÂ≠êËäÇÁÇπ
            if (node.childrenList) {
                node.childrenList.forEach(child => {
                    extractStateRecursively(child, state);
                });
            }
        }

        // Ëß£ÊûêÁä∂ÊÄÅË∑ØÂæÑ
        function parseStatePath(fullText, extractedValue) {
            const colonIndex = fullText.indexOf(': ');
            if (colonIndex === -1) {
                return { path: fullText.trim(), value: extractedValue || 'undefined' };
            }
            
            const path = fullText.substring(0, colonIndex).trim();
            let value = fullText.substring(colonIndex + 2).trim();
            
            // Â¶ÇÊûúÊúâ‰ªéarguments‰∏≠ÊèêÂèñÁöÑÂÄºÔºå‰ºòÂÖà‰ΩøÁî®
            if (extractedValue && extractedValue !== 'undefined') {
                value = extractedValue;
            }
            
            // Ê∏ÖÁêÜÂºïÂè∑
            value = value.replace(/^['"]|['"]$/g, '');
            
            return { path, value };
        }

        // Ê∏≤ÊüìGlobal StateÂ∑ÆÂºÇ
        function renderGlobalStateDiff(diff) {
            let md = '';
            
            // ÊåâË∑ØÂæÑÁ±ªÂûãÂàÜÁªÑ
            const groups = {
                'storage': { title: 'Storage Changes', items: [] },
                'balance': { title: 'Balance Changes', items: [] },
                'ghost': { title: 'Ghost Variable Changes', items: [] }
            };
            
            Object.entries(diff).forEach(([path, change]) => {
                let groupType = 'storage'; // ÈªòËÆ§ÂàÜÁ±ª‰∏∫storage
                
                if (path.includes('.balance:') || path.endsWith('.balance')) {
                    groupType = 'balance';
                } else if (path.includes('isInPlotIndexes') || path.includes('sumOfHarvestedBeans')) {
                    groupType = 'ghost';
                } else if (path.startsWith('s.') || path.includes('s.accts') || path.includes('s.sys')) {
                    groupType = 'storage';
                }
                
                groups[groupType].items.push({ path, change });
            });
            
            // Ê∏≤ÊüìÂêÑÁªÑ
            Object.entries(groups).forEach(([groupKey, group]) => {
                if (group.items.length > 0) {
                    md += `### ${group.title}\n\n`;
                    
                    group.items.forEach(({ path, change }) => {
                        if (change.changed) {
                            md += `- **${path}**: \`${change.from}\` ‚Üí \`${change.to}\`\n\n`;
                        } else {
                            md += `- **${path}**: \`${change.to}\` *(unchanged)*\n\n`;
                        }
                    });
                    
                    md += `\n`;
                }
            });
            
            return md;
        }

        // Ê†ºÂºèÂåñËßÑÂàôÂêçÁß∞ÔºåÊòæÁ§∫Â±ÇÁ∫ßÁªìÊûÑ
        function formatRuleName(ruleName) {
            const parts = ruleName.split(' > ');
            if (parts.length === 1) {
                return `<strong>${parts[0]}</strong>`;
            }
            
            // ‰∏ªËßÑÂàôÂêç
            let formatted = `<strong>${parts[0]}</strong>`;
            
            // Â¶ÇÊûúÊúâÂ≠êÁ∫ßÔºåÊòæÁ§∫ÊúÄÂêé‰∏ÄÁ∫ßÂíåÂ±ÇÁ∫ßÊï∞
            if (parts.length > 1) {
                const lastPart = parts[parts.length - 1];
                formatted += `<br><span style="color: #6c757d; font-size: 13px; margin-left: 20px;">
                    ‚Ü≥ ${lastPart} <em>(Â±ÇÁ∫ß: ${parts.length})</em>
                </span>`;
            }
            
            return formatted;
        }

        // Ëé∑ÂèñÁÆÄÂåñÁöÑÊñá‰ª∂Âêç
        function getSimpleFileName(ruleName) {
            const parts = ruleName.split(' > ');
            // Âèñ‰∏ªËßÑÂàôÂêçÂíåÊúÄÂêé‰∏ÄÈÉ®ÂàÜ
            if (parts.length === 1) {
                return parts[0];
            }
            // Â¶ÇÊûúÊúâÂ§öÂ±ÇÔºå‰ΩøÁî®‰∏ªËßÑÂàôÂêç_ÊúÄÂêé‰∏ÄÂ±Ç
            const mainRule = parts[0];
            const lastPart = parts[parts.length - 1]
                .replace(/[\(\)]/g, '')
                .replace(/[,\s]+/g, '_')
                .substring(0, 30); // ÈôêÂà∂ÈïøÂ∫¶
            return `${mainRule}_${lastPart}`;
        }

        function displayMarkdown(content, ruleName) {
            // ‰ΩøÁî®ÁÆÄÂåñÁöÑÊñá‰ª∂Âêç
            const fileName = getSimpleFileName(ruleName);
            const cleanName = fileName.replace(/[^a-zA-Z0-9_-]/g, '_').replace(/__+/g, '_');
            
            // ÂàõÂª∫ÊòæÁ§∫ÂÆπÂô®
            const outputDiv = document.createElement('div');
            outputDiv.className = 'markdown-output';
            outputDiv.innerHTML = `
                <div class="markdown-header">
                    <div class="markdown-title">
                        üìù ${cleanName}.md
                    </div>
                    <button class="copy-btn" onclick="copyMarkdown(this)">
                        üìã Â§çÂà∂ Markdown
                    </button>
                </div>
                <div class="markdown-content">
                    <pre>${escapeHtml(content)}</pre>
                </div>
            `;
            
            // Â∞ÜËæìÂá∫Ê∑ªÂä†Âà∞ÁªìÊûúÂå∫Âüü
            const resultSection = document.getElementById('result-section');
            resultSection.appendChild(outputDiv);
        }

        function copyMarkdown(button) {
            const markdownContent = button.closest('.markdown-output').querySelector('pre').textContent;
            
            navigator.clipboard.writeText(markdownContent).then(() => {
                const originalText = button.textContent;
                button.textContent = 'üéâ Â∑≤Â§çÂà∂ÔºÅ';
                button.style.background = '#28a745';
                button.style.color = 'white';
                
                showStatus('üéâ MarkdownÂ∑≤ÊàêÂäüÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                showCopySuccess();
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                    button.style.color = '';
                }, 3000);
            }).catch(err => {
                // ÈôçÁ∫ßÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = markdownContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                button.textContent = 'üéâ Â∑≤Â§çÂà∂ÔºÅ';
                showStatus('üéâ MarkdownÂ∑≤ÊàêÂäüÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                showCopySuccess();
                setTimeout(() => {
                    button.textContent = 'üìã Â§çÂà∂ Markdown';
                }, 3000);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÁöÑÂä®ÁîªÊèêÁ§∫
        function showCopySuccess() {
            // ÂàõÂª∫‰∏¥Êó∂ÊèêÁ§∫ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.innerHTML = 'üéâ Â§çÂà∂ÊàêÂäüÔºÅ';
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #28a745;
                color: white;
                padding: 20px 40px;
                border-radius: 10px;
                font-size: 18px;
                font-weight: bold;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: copySuccessAnimation 0.6s ease-out;
            `;
            
            // Ê∑ªÂä†CSSÂä®Áîª
            if (!document.querySelector('#copySuccessStyle')) {
                const style = document.createElement('style');
                style.id = 'copySuccessStyle';
                style.textContent = `
                    @keyframes copySuccessAnimation {
                        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
                        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // 2ÁßíÂêéÁßªÈô§
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 2000);
        }

        // ÂàáÊç¢Âçï‰∏™ËßÑÂàôÁöÑMarkdownÊòæÁ§∫
        function toggleMarkdown(index) {
            const rule = allRulesData.rules[index];
            if (!rule.content) return;
            
            const contentDiv = document.getElementById(`rule-content-${index}`);
            
            if (contentDiv.style.display === 'none') {
                // ÁîüÊàêÂπ∂ÊòæÁ§∫Markdown
                const md = convertToMarkdown(rule);
                contentDiv.innerHTML = `<pre>${escapeHtml(md)}</pre>`;
                contentDiv.style.display = 'block';
            } else {
                // ÈöêËóèMarkdown
                contentDiv.style.display = 'none';
            }
        }

        // Â§çÂà∂Âçï‰∏™ËßÑÂàôÁöÑMarkdown
        function copyRuleMarkdown(index) {
            const rule = allRulesData.rules[index];
            if (!rule.content) return;
            
            const md = convertToMarkdown(rule);
            
            navigator.clipboard.writeText(md).then(() => {
                showStatus('üéâ MarkdownÂ∑≤ÊàêÂäüÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                // Ê∑ªÂä†‰∏¥Êó∂È´ò‰∫ÆÊèêÁ§∫
                showCopySuccess();
            }).catch(() => {
                // ÈôçÁ∫ßÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = md;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('üéâ MarkdownÂ∑≤ÊàêÂäüÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                showCopySuccess();
            });
        }

        function downloadJson(index) {
            const rule = allRulesData.rules[index];
            if (!rule.content) return;

            const blob = new Blob([JSON.stringify(rule.content, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = rule.outputFile;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadAllJsons() {
            if (!allRulesData) return;

            allRulesData.rules.forEach(rule => {
                if (rule.content) {
                    const blob = new Blob([JSON.stringify(rule.content, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = rule.outputFile;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            });
        }

        function exportSummary() {
            if (!allRulesData) return;

            let summary = `# Certora Analysis Summary\n\n`;
            summary += `**URL:** ${allRulesData.url}\n`;
            summary += `**Time:** ${new Date(allRulesData.timestamp).toLocaleString('zh-CN')}\n`;
            summary += `**Total Rules:** ${allRulesData.totalRules}\n\n`;
            
            summary += `## Failed Rules\n\n`;
            allRulesData.rules.forEach((rule, i) => {
                summary += `${i + 1}. **${rule.ruleName}**\n`;
                summary += `   - Status: ${rule.status}\n`;
                summary += `   - File: ${rule.outputFile}\n`;
                summary += `   - Content: ${rule.content ? '‚úÖ Retrieved' : '‚ùå Failed'}\n\n`;
            });
            
            downloadMarkdown(summary, 'certora_summary.md');
            showStatus('‚úÖ Êä•ÂëäÂ∑≤ÂØºÂá∫', 'success');
        }

        // ÂêØÂä®ÊèêÁ§∫
        window.addEventListener('DOMContentLoaded', () => {
            showStatus('ËØ∑ÂÖàËøêË°å: node scripts/certora_auto_server.mjs', 'info');
        });
    </script>
</body>
</html>